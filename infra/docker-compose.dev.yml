version: "3.9"

services:
  # PostgreSQL for IAM Service
  iam-db:
    image: postgres:16
    container_name: iam-db
    environment:
      POSTGRES_USER: iam_user
      POSTGRES_PASSWORD: iam_password
      POSTGRES_DB: iam_service_db
    ports:
      - "5433:5432"
    volumes:
      - iam-db-data:/var/lib/postgresql/data
    networks:
      - bankingsuite-network

  # PostgreSQL for Customer Service
  customer-db:
    image: postgres:16
    container_name: customer-db
    environment:
      POSTGRES_USER: customer_user
      POSTGRES_PASSWORD: customer_password
      POSTGRES_DB: customer_service_db
    ports:
      - "5434:5432"
    volumes:
      - customer-db-data:/var/lib/postgresql/data
    networks:
      - bankingsuite-network

  # PostgreSQL for Account Service
  account-db:
    image: postgres:16
    container_name: account-db
    environment:
      POSTGRES_USER: account_user
      POSTGRES_PASSWORD: account_password
      POSTGRES_DB: account_service_db
    ports:
      - "5435:5432"
    volumes:
      - account-db-data:/var/lib/postgresql/data
    networks:
      - bankingsuite-network

  # PostgreSQL for Transaction Service
  transaction-db:
    image: postgres:16
    container_name: transaction-db
    environment:
      POSTGRES_USER: transaction_user
      POSTGRES_PASSWORD: transaction_password
      POSTGRES_DB: transaction_service_db
    ports:
      - "5436:5432"
    volumes:
      - transaction-db-data:/var/lib/postgresql/data
    networks:
      - bankingsuite-network

  # PostgreSQL for Notification Service (optional but keeps pattern consistent)
  notification-db:
    image: postgres:16
    container_name: notification-db
    environment:
      POSTGRES_USER: notification_user
      POSTGRES_PASSWORD: notification_password
      POSTGRES_DB: notification_service_db
    ports:
      - "5437:5432"
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    networks:
      - bankingsuite-network

  # RabbitMQ broker for messaging
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: rabbitmq
      RABBITMQ_DEFAULT_PASS: rabbitmq
    networks:
      - bankingsuite-network

    # IAM Service API (.NET 10 + FastEndpoints)
  iam-service:
    container_name: iam-service
    build:
      # context is the repo root (one level above infra/)
      context: ..
      # Dockerfile path is relative to that repo root
      dockerfile: src/backend/services/IamService/BankingSuite.IamService.Api/Dockerfile
    depends_on:
      - iam-db
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:8080

      # Connection string must match what your IamService expects (key name)
      # If your appsettings.json uses "ConnectionStrings:DefaultConnection" or similar,
      # change the name below accordingly.
      ConnectionStrings__IamDatabase: Host=iam-db;Port=5432;Database=iam_service_db;Username=iam_user;Password=iam_password;

      # These must match your Angular routes
      Iam__EmailConfirmationBaseUrl: http://localhost:4200/email-confirmation
      Iam__PasswordResetBaseUrl: http://localhost:4200/reset-password

      Email__FromName: "Alvor Bank IAM"
      Email__FromAddress: "no-reply@alvorbank.test"
      Email__Host: "sandbox.smtp.mailtrap.io"
      Email__Port: "587"
      Email__User: "eb31dfb6ec85a3"
      Email__Password: "11a50f51b217bc"
      Email__UseSsl: "true"

      # Optional: if you use any JWT / issuer config via env, set here too
      # Jwt__Issuer: ...
      # Jwt__Audience: ...
      # Jwt__Key: ...
    ports:
      - "5001:8080"
    networks:
      - bankingsuite-network

networks:
  bankingsuite-network:
    driver: bridge

volumes:
  iam-db-data:
  customer-db-data:
  account-db-data:
  transaction-db-data:
  notification-db-data:
